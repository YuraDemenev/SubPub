# PubSub service

PubSub service это микросервис реализующий паттерн PubSub, он позволяет подписываться на получения сообщения по специальному ключу subject и публиковать сообщения для всех подписчиков.<br>

Проект имеет следующую структуру

<strong>cmd/server</strong> - содержит файл main.go запускающий gRPC сервер.<br>
<strong>config</strong> - содержит файл config.yml с параметрами для запуска gRPC.<br>
<strong>internal/app</strong> - содержит конструктор app, app нужно для реализации Dependency Injection, чтобы gRPC сервер, заботился только о gRPC.<br>
<strong>internal/config</strong> - содержит конструктор config, также нужен для реализации Dependency Injection.<br>
<strong>internal/server</strong> - содержит реализацию gRPC server и тесты для server.<br>
<strong>proto</strong> - хранит файл pubsub.proto и папку с компилированным кодом protogen
<strong>subpub</strong> - хранит subpun.go в котором реализована шина subPub, тесты для subpub и сгенерированный mock файл.

# Важные моменты SubPub

<li>Для рассылки всех сообщений создаётся worker pool в котором, создаются 10 workers, которые читают данные из канала и рассылают подписчикам. Так как в interface NewSubPub нет входных значений, то кол-во workers фиксированно.
<li>Сообщения отправляются в централизированный канал, который имеет буфер, буфер так же как и workers фиксирован так как interface NewSubPub не имеет входных значений.
<li>Для того, чтобы не было проблем при переполнении буфера, при полном буфере данные уходят в ветку default тем самым не тормозя процесс, и попадают в список не отправленных сообщений, также посылается сигнал в специальный канал <strong>undelSygnalCh chan struct{}</strong>, чтобы workers считывали сообщения из списка не отрпавленных сообщений.
<li>Важным моментом при публикации, является то, что тема создаётся только при подписке на тему и если все пользователи отпишутся тема удалится, поэтому при публикации в тему с 0 подписчиков, будет возвращена ошибка.
<li>SubPub имеет логи для того, чтобы можно было контролировать процесс работы программы и легче в случаи ошибки, находить момент, когда она произошла, логгер используется logrus.
<li>Для того, чтобы проверить SubPub были написаны тесты находящиеся в subpub_test.
<li>Для того, чтобы отслеживать не закрыт ли SubPub используется bool flag, который проверяется под Mutex.
<li>Чтобы сигнализировать о останвке SubPub имеется канал stopCh, который при закрытии сигнализирует воркерам заканчивать работу и закрывать subPub.
<li>Для хранения подписчиков используется <strong>map[string]map[*subscription]struct{}</strong>, это позволяет иметь 1 теме множество подписчиков и удалять их за O(1).

# Server

gRPC - сервер, реализованный в пакете internal/server, предоставляет интерфейс для подписки и публикации событий, описанных в proto/pubsub.proto. Сервер взаимодействует с subPub для управления подписками и доставкой сообщений<br>

# Важные мометны Server

<li> Сервер использует gRPC статусы для ошибок, использует app и config для Dependency Injection.
<li> Для передачи сообщений сервер создаёт callback функцию, которая передаётся в качестве MessageHandler и внутри себя передаёт event в канал, после он передаётся в gRPC stream
<li> Server использует логи с помощью библиотеки logrus.
<li> Server после запуска ожидает сигналы SIGINT или SIGTERM для завершения программы, и subPub.

# Использованные паттерны

<li>Dependency Injection: Зависимости (subpub, логгер, конфиг) внедряются через конструкторы internal/app и internal/server.
<li>Graceful Shutdown: Корректное завершение gRPC-соединений и subpub с таймаутом.
<li>Error Handling: Централизованная обработка ошибок с преобразованием в gRPC-статусы.
<li>Context Propagation: Использование context.Context для управления подписками и отменой.
<li>Configuration Management: Гибкая загрузка конфигурации из config.yml.
Эти паттерны обеспечивают надёжность, тестируемость и удобство поддержки сервера.

# Как собрать сервис

При сборки сервиса, предполагается что вы установил Go и protoc.<br>
Для запуска склонируйте репозиторий

```
git clone https://github.com/YuraDemenev/SubPub.git
```

установите зависимости Go

```
go mod tidy
```

Настройте при необходимости config.yml.<br>
Для остановки сервиса отправьте сигнал SIGINT (Ctrl+C) или SIGTERM, сервис закроет gRPC соеlинение, завершит subpub и напишит в логи.
